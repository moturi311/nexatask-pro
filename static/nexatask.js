// NexaTask Pro - Main Application
const AppState={currentPage:'splash',currentView:'tasks',currentSlide:0,tasks:[],preferences:{theme:'light',first_visit:true},currentFilter:'all',editingTask:null};

// Splash Screen
class SplashScreen{constructor(){this.canvas=document.getElementById('particleCanvas');this.ctx=this.canvas?.getContext('2d');this.particles=[];this.features=['Smart Task Organization','Beautiful Analytics','Powerful Features','Seamless Experience'];this.currentFeature=0}
init(){if(!this.canvas)return;this.setupCanvas();this.createParticles();this.animate();this.startLoading();this.rotateFeatures()}
setupCanvas(){this.canvas.width=window.innerWidth;this.canvas.height=window.innerHeight}
createParticles(){for(let i=0;i<50;i++){this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,size:Math.random()*3+1,speedX:Math.random()*0.5-0.25,speedY:Math.random()*0.5-0.25,opacity:Math.random()*0.5+0.3})}}
animate(){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.particles.forEach(p=>{p.x+=p.speedX;p.y+=p.speedY;if(p.x<0||p.x>this.canvas.width)p.speedX*=-1;if(p.y<0||p.y>this.canvas.height)p.speedY*=-1;this.ctx.beginPath();this.ctx.arc(p.x,p.y,p.size,0,Math.PI*2);this.ctx.fillStyle=`rgba(255,255,255,${p.opacity})`;this.ctx.fill()});requestAnimationFrame(()=>this.animate())}
startLoading(){const bar=document.querySelector('.loading-progress'),pct=document.querySelector('.loading-percentage');let p=0;const int=setInterval(()=>{p+=Math.random()*15;if(p>100)p=100;if(bar)bar.style.width=p+'%';if(pct)pct.textContent=Math.floor(p)+'%';if(p>=100){clearInterval(int);setTimeout(()=>this.complete(),500)}},200)}
rotateFeatures(){const ft=document.querySelector('.feature-text');if(!ft)return;setInterval(()=>{ft.textContent=this.features[this.currentFeature];this.currentFeature=(this.currentFeature+1)%this.features.length},2000)}
complete(){PageManager.showPage(AppState.preferences.first_visit?'onboarding':'dashboard')}}

// Onboarding
class Onboarding{constructor(){this.currentSlide=0;this.totalSlides=3}
init(){this.setupEventListeners();this.updateSlide()}
setupEventListeners(){document.getElementById('nextSlide')?.addEventListener('click',()=>this.nextSlide());document.getElementById('skipOnboarding')?.addEventListener('click',()=>this.complete());document.getElementById('startApp')?.addEventListener('click',()=>this.complete());document.querySelectorAll('.theme-option').forEach(o=>o.addEventListener('click',()=>{document.querySelectorAll('.theme-option').forEach(x=>x.classList.remove('active'));o.classList.add('active');AppState.preferences.theme=o.dataset.theme}))}
nextSlide(){if(this.currentSlide<this.totalSlides-1){this.currentSlide++;this.updateSlide()}}
updateSlide(){const slides=document.querySelectorAll('.slide'),dots=document.querySelectorAll('.dot');slides.forEach((s,i)=>{s.classList.remove('active','prev');if(i===this.currentSlide)s.classList.add('active');else if(i<this.currentSlide)s.classList.add('prev')});dots.forEach((d,i)=>d.classList.toggle('active',i===this.currentSlide));const nextBtn=document.getElementById('nextSlide'),startBtn=document.getElementById('startApp');if(this.currentSlide===this.totalSlides-1){nextBtn.style.display='none';startBtn.style.display='block'}else{nextBtn.style.display='block';startBtn.style.display='none'}}
complete(){AppState.preferences.first_visit=false;API.updatePreferences(AppState.preferences);PageManager.showPage('dashboard')}}

// Page Manager
class PageManager{static showPage(n){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));const t=document.getElementById(n+'Screen');if(t){t.classList.add('active');AppState.currentPage=n;if(n==='dashboard')Dashboard.init()}}}

// Dashboard
class Dashboard{static init(){this.setupEventListeners();this.updateGreeting();this.updateDate();this.loadTasks();this.loadAnalytics();this.loadPreferences()}
static setupEventListeners(){document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>this.switchView(b.dataset.view)));const qi=document.getElementById('quickTaskInput');qi?.addEventListener('keypress',e=>{if(e.key==='Enter')this.addQuickTask()});document.getElementById('addQuickTask')?.addEventListener('click',()=>this.addQuickTask());document.getElementById('openTaskModal')?.addEventListener('click',()=>TaskModal.open());document.querySelectorAll('.filter-chip').forEach(c=>c.addEventListener('click',()=>{document.querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');AppState.currentFilter=c.dataset.filter;this.renderTasks()}));document.getElementById('themeToggle')?.addEventListener('click',()=>this.toggleTheme());document.querySelectorAll('.theme-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.theme-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');this.applyTheme(b.dataset.theme)}));document.getElementById('primaryColor')?.addEventListener('change',e=>this.applyPrimaryColor(e.target.value));document.getElementById('exportData')?.addEventListener('click',()=>this.exportData());document.getElementById('clearAllData')?.addEventListener('click',()=>this.clearAllData())}
static updateGreeting(){const g=document.getElementById('greeting');if(!g)return;const h=new Date().getHours();g.textContent=h<12?'Good Morning':h<17?'Good Afternoon':'Good Evening'}
static updateDate(){const d=document.getElementById('currentDate');if(d)d.textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
static switchView(v){document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));document.querySelector(`[data-view="${v}"]`)?.classList.add('active');document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));document.getElementById(v+'View')?.classList.add('active');AppState.currentView=v;if(v==='analytics')this.loadAnalytics()}
static async loadTasks(){try{AppState.tasks=await API.getTasks();this.renderTasks();this.updateStats()}catch(e){console.error('Error:',e);Toast.show('Error loading tasks','error')}}
static renderTasks(){const c=document.getElementById('tasksContainer'),e=document.getElementById('emptyState');if(!c)return;let ft=AppState.tasks;switch(AppState.currentFilter){case'pending':ft=AppState.tasks.filter(t=>!t.completed);break;case'completed':ft=AppState.tasks.filter(t=>t.completed);break;case'high':ft=AppState.tasks.filter(t=>t.priority===3);break}if(ft.length===0){e?.classList.remove('hidden');c.querySelectorAll('.task-card').forEach(x=>x.remove());return}else{e?.classList.add('hidden')}c.querySelectorAll('.task-card').forEach(x=>x.remove());ft.forEach((t,i)=>c.insertBefore(this.createTaskCard(t,i),e))}
static createTaskCard(t,i){const c=document.createElement('div');c.className=`task-card ${t.completed?'completed':''}`;c.style.animationDelay=`${i*0.05}s`;const pc=t.priority===1?'low':t.priority===2?'medium':'high';c.innerHTML=`<div class="task-checkbox ${t.completed?'checked':''}" data-id="${t.id}"></div><div class="task-info"><div class="task-title">${this.esc(t.title)}</div><div class="task-meta"><span class="task-category">${t.category}</span><span class="task-priority ${pc}"></span>${t.due_date?`<span class="task-due">üìÖ ${t.due_date}</span>`:''}</div></div><div class="task-actions"><button class="task-btn edit" data-id="${t.id}">‚úèÔ∏è</button><button class="task-btn delete" data-id="${t.id}">üóë</button></div>`;c.querySelector('.task-checkbox').addEventListener('click',()=>this.toggleTask(t.id));c.querySelector('.edit').addEventListener('click',e=>{e.stopPropagation();TaskModal.open(t)});c.querySelector('.delete').addEventListener('click',e=>{e.stopPropagation();this.deleteTask(t.id)});return c}
static async addQuickTask(){const i=document.getElementById('quickTaskInput'),t=i?.value.trim();if(!t){Toast.show('Please enter a task','warning');return}try{await API.createTask({title:t,category:'General',priority:1});i.value='';await this.loadTasks();Toast.show('Task added','success')}catch(e){Toast.show('Error adding task','error')}}
static async toggleTask(id){const t=AppState.tasks.find(x=>x.id===id);if(!t)return;try{await API.updateTask(id,{completed:!t.completed});await this.loadTasks();if(!t.completed){Toast.show('Task completed! üéâ','success');this.createConfetti()}}catch(e){Toast.show('Error updating task','error')}}
static async deleteTask(id){if(!confirm('Delete this task?'))return;try{await API.deleteTask(id);await this.loadTasks();Toast.show('Task deleted','success')}catch(e){Toast.show('Error deleting task','error')}}
static updateStats(){const t=AppState.tasks.length,c=AppState.tasks.filter(x=>x.completed).length,p=t-c;this.animateNumber('statTotal',t);this.animateNumber('statCompleted',c);this.animateNumber('statPending',p);this.updateProgressRing(t>0?(c/t)*100:0)}
static animateNumber(id,tgt){const el=document.getElementById(id);if(!el)return;const s=parseInt(el.textContent)||0,dur=500,st=Date.now();const an=()=>{const e=Date.now()-st,pr=Math.min(e/dur,1),cur=Math.floor(s+(tgt-s)*pr);el.textContent=cur;if(pr<1)requestAnimationFrame(an)};an()}
static updateProgressRing(p){const c=document.getElementById('progressCircle'),pel=document.getElementById('todayPercentage');if(c){const cir=314,off=cir-(p/100)*cir;c.style.strokeDashoffset=off}if(pel)pel.textContent=Math.round(p)+'%'}
static async loadAnalytics(){try{const a=await API.getAnalytics();document.getElementById('completionRate').textContent=a.completion_rate+'%';document.getElementById('streakDays').textContent=a.productivity_streak;this.renderCategoryBreakdown(a.tasks_by_category)}catch(e){console.error('Error:',e)}}
static renderCategoryBreakdown(cat){const c=document.getElementById('categoryBreakdown');if(!c)return;c.innerHTML='';const tot=Object.values(cat).reduce((a,b)=>a+b,0);Object.entries(cat).forEach(([n,cnt])=>{const p=tot>0?(cnt/tot)*100:0;const i=document.createElement('div');i.className='category-item';i.innerHTML=`<span class="category-name">${n}</span><div class="category-bar"><div class="category-fill" style="width:${p}%"></div></div><span class="category-count">${cnt}</span>`;c.appendChild(i)})}
static async loadPreferences(){try{const p=await API.getPreferences();AppState.preferences=p;this.applyTheme(p.theme)}catch(e){console.error('Error:',e)}}
static toggleTheme(){const cur=document.body.dataset.theme||'light';this.applyTheme(cur==='light'?'dark':'light')}
static applyTheme(t){document.body.dataset.theme=t;AppState.preferences.theme=t;API.updatePreferences(AppState.preferences)}
static applyPrimaryColor(c){document.documentElement.style.setProperty('--primary',c);AppState.preferences.primary_color=c;API.updatePreferences(AppState.preferences)}
static createConfetti(){for(let i=0;i<30;i++){setTimeout(()=>{const cf=document.createElement('div');cf.className='confetti';cf.style.left=Math.random()*100+'%';cf.style.backgroundColor=['#667eea','#764ba2','#f093fb','#10b981'][Math.floor(Math.random()*4)];cf.style.animationDelay=Math.random()*0.5+'s';document.body.appendChild(cf);setTimeout(()=>cf.remove(),3000)},i*30)}}
static exportData(){const d={tasks:AppState.tasks,preferences:AppState.preferences,exportDate:new Date().toISOString()};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`nexatask-export-${Date.now()}.json`;a.click();URL.revokeObjectURL(u);Toast.show('Data exported','success')}
static async clearAllData(){if(!confirm('Clear ALL data?'))return;if(!confirm('This will delete all tasks. Are you sure?'))return;try{for(const t of AppState.tasks)await API.deleteTask(t.id);await this.loadTasks();Toast.show('All data cleared','success')}catch(e){Toast.show('Error clearing data','error')}}
static esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}}

// Task Modal
class TaskModal{static open(t=null){const m=document.getElementById('taskModal');if(!m)return;AppState.editingTask=t;m.classList.add('active');if(t){document.getElementById('modalTitle').textContent='Edit Task';document.getElementById('taskTitle').value=t.title;document.getElementById('taskDescription').value=t.description||'';document.getElementById('taskDueDate').value=t.due_date||'';document.querySelectorAll('.category-btn').forEach(b=>b.classList.toggle('active',b.dataset.category===t.category));document.querySelectorAll('.priority-btn').forEach(b=>b.classList.toggle('active',b.dataset.priority==t.priority));const tc=document.getElementById('tagsContainer');tc.innerHTML='';(t.tags||[]).forEach(tag=>this.addTag(tag));document.getElementById('saveTask').textContent='Update Task'}else{this.reset()}this.setupModalListeners()}
static setupModalListeners(){document.getElementById('closeModal')?.addEventListener('click',()=>this.close());document.getElementById('modalOverlay')?.addEventListener('click',()=>this.close());document.getElementById('cancelTask')?.addEventListener('click',()=>this.close());document.getElementById('saveTask')?.addEventListener('click',()=>this.save());const ti=document.getElementById('taskTitle'),cnt=document.getElementById('titleCounter');ti?.addEventListener('input',()=>{if(cnt)cnt.textContent=ti.value.length});document.querySelectorAll('.category-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.category-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active')}));document.querySelectorAll('.priority-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.priority-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active')}));const tgi=document.getElementById('tagInput');tgi?.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();const tg=tgi.value.trim();if(tg){this.addTag(tg);tgi.value=''}}})}
static addTag(txt){const c=document.getElementById('tagsContainer');if(!c)return;const t=document.createElement('div');t.className='tag';t.innerHTML=`${txt}<button class="tag-remove">√ó</button>`;t.querySelector('.tag-remove').addEventListener('click',()=>t.remove());c.appendChild(t)}
static async save(){const title=document.getElementById('taskTitle')?.value.trim();if(!title){Toast.show('Please enter a task title','warning');return}const desc=document.getElementById('taskDescription')?.value||'',cat=document.querySelector('.category-btn.active')?.dataset.category||'General',pri=parseInt(document.querySelector('.priority-btn.active')?.dataset.priority||'1'),due=document.getElementById('taskDueDate')?.value||null,tags=Array.from(document.querySelectorAll('.tag')).map(t=>t.textContent.replace('√ó','').trim());const td={title,description:desc,category:cat,priority:pri,due_date:due,tags};try{if(AppState.editingTask){await API.updateTask(AppState.editingTask.id,td);Toast.show('Task updated','success')}else{await API.createTask(td);Toast.show('Task created','success')}this.close();Dashboard.loadTasks()}catch(e){Toast.show('Error saving task','error')}}
static close(){document.getElementById('taskModal')?.classList.remove('active');AppState.editingTask=null}
static reset(){document.getElementById('modalTitle').textContent='Create New Task';document.getElementById('taskTitle').value='';document.getElementById('taskDescription').value='';document.getElementById('taskDueDate').value='';document.getElementById('titleCounter').textContent='0';document.getElementById('tagsContainer').innerHTML='';document.querySelectorAll('.category-btn').forEach((b,i)=>b.classList.toggle('active',i===0));document.querySelectorAll('.priority-btn').forEach((b,i)=>b.classList.toggle('active',i===0));document.getElementById('saveTask').textContent='Create Task'}}

// Toast
class Toast{static show(m,t='info'){const c=document.getElementById('toastContainer');if(!c)return;const ts=document.createElement('div');ts.className=`toast ${t}`;const ic={'success':'‚úì','error':'‚úï','warning':'‚ö†','info':'‚Ñπ'};ts.innerHTML=`<div class="toast-icon">${ic[t]}</div><div class="toast-content"><div class="toast-message">${m}</div></div><button class="toast-close">√ó</button>`;ts.querySelector('.toast-close').addEventListener('click',()=>this.remove(ts));c.appendChild(ts);setTimeout(()=>this.remove(ts),4000)}
static remove(t){t.style.animation='fadeOut 0.3s ease-out';setTimeout(()=>t.remove(),300)}}

// API
class API{static async getTasks(){return(await fetch('/api/tasks')).json()}
static async createTask(d){return(await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)})).json()}
static async updateTask(id,d){return(await fetch(`/api/tasks/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)})).json()}
static async deleteTask(id){return(await fetch(`/api/tasks/${id}`,{method:'DELETE'})).json()}
static async getAnalytics(){return(await fetch('/api/analytics')).json()}
static async getPreferences(){return(await fetch('/api/preferences')).json()}
static async updatePreferences(p){return(await fetch('/api/preferences',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)})).json()}}

// Init
document.addEventListener('DOMContentLoaded',()=>{new SplashScreen().init();new Onboarding().init();document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();TaskModal.open()}if(e.key==='Escape'){const m=document.getElementById('taskModal');if(m?.classList.contains('active'))TaskModal.close()}})});
